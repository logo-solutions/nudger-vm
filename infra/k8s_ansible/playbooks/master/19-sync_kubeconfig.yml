---
# playbooks/master/19-sync_kubeconfig.yml
# Synchroniser kubeconfig depuis master1 vers bastion

- name: RÃ©cupÃ©rer kubeconfig depuis master
  hosts: master
  gather_facts: false
  become: true

  tasks:
    - name: Lire le kubeconfig du master
      ansible.builtin.slurp:
        src: /etc/kubernetes/admin.conf
      register: admin_conf_raw

    - name: Sauvegarder le contenu dans un fichier temporaire local sur bastion
      delegate_to: bastion_host
      run_once: true
      ansible.builtin.copy:
        content: "{{ admin_conf_raw.content | b64decode }}"
        dest: "/tmp/admin.conf.master1"
        mode: "0600"

# ======================================================================
#                   BASTION: DÃ©ploiement du kubeconfig
# ======================================================================

- name: DÃ©ployer kubeconfig sur bastion
  hosts: bastion
  become: true

  vars:
    kubeconfig_path: "/root/.kube/config"

  # ğŸ‘‡ Ici le bloc ajoutÃ©, bien placÃ© dans le play bastion
  pre_tasks:
    - name: Ajouter la clÃ© GPG officielle Kubernetes
      ansible.builtin.shell: |
        set -e
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | \
          gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Ajouter le dÃ©pÃ´t APT Kubernetes (v1.31)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /
        mode: "0644"

    - name: Mettre Ã  jour le cache APT
      ansible.builtin.apt:
        update_cache: yes

    - name: Installer kubectl sur bastion
      ansible.builtin.apt:
        name: kubectl
        state: present

  tasks:
    - name: CrÃ©er le dossier ~/.kube
      ansible.builtin.file:
        path: "/root/.kube"
        state: directory
        mode: "0700"

    - name: Copier le kubeconfig depuis /tmp vers ~/.kube/config
      ansible.builtin.copy:
        src: "/tmp/admin.conf.master1"
        dest: "{{ kubeconfig_path }}"
        mode: "0600"

    - name: Supprimer le fichier temporaire
      ansible.builtin.file:
        path: "/tmp/admin.conf.master1"
        state: absent

    - name: DÃ©finir KUBECONFIG globalement dans /etc/profile.d
      ansible.builtin.copy:
        dest: /etc/profile.d/kubeconfig.sh
        content: |
          export KUBECONFIG={{ kubeconfig_path }}
        mode: "0644"

    - name: Test de connexion au cluster
      ansible.builtin.command: kubectl get nodes
      register: kubectl_check
      changed_when: false

    - name: Afficher le rÃ©sultat
      ansible.builtin.debug:
        msg: "{{ kubectl_check.stdout_lines }}"

    - name: Supprimer le taint control-plane sur master1 (cluster single-master)
      ansible.builtin.command: >
        kubectl taint nodes master1 node-role.kubernetes.io/control-plane:NoSchedule-
      register: untaint_result
      changed_when: "'taint(s) removed' in untaint_result.stdout"
      failed_when: false

    - name: VÃ©rifier les taints restants
      ansible.builtin.shell: |
        kubectl describe node master1 | grep Taints || true
      register: taints_check
      changed_when: false
      failed_when: false

    - name: Afficher l'Ã©tat final du nÅ“ud master1
      ansible.builtin.debug:
        msg: "{{ taints_check.stdout_lines }}"
