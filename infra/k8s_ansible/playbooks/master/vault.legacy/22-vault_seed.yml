---
- name: Injecter les secrets Bitwarden dans Vault Kubernetes
  hosts: bastion
  become: true
  vars:
    namespace: "vault"
    artifact_dir: "/root/.ansible/artifacts/master1"
    artifact_file: "{{ artifact_dir }}/vault-k8s-init.json"
    vault_addr: "http://127.0.0.1:8200"
    bw_session: "{{ lookup('env', 'BW_SESSION') }}"

  tasks:
    - name: V√©rifier si BW_SESSION est d√©fini
      ansible.builtin.set_fact:
        bw_session: "{{ lookup('env', 'BW_SESSION') | default('') }}"

    - name: Afficher une aide pour g√©n√©rer BW_SESSION si n√©cessaire
      ansible.builtin.debug:
        msg:
          - "‚ö†Ô∏è  La variable d‚Äôenvironnement BW_SESSION n‚Äôest pas d√©finie."
          - "üëâ  Pour la cr√©er manuellement, ex√©cute sur le bastion :"
          - "     export BW_SESSION=$(bw unlock --raw)"
          - "     echo $BW_SESSION"
          - "üí°  Tu peux aussi la saisir directement ci-dessous."
      when: bw_session == ""

    - name: Demander la session Bitwarden si absente
      ansible.builtin.pause:
        prompt: |
          üîê Entre le token BW_SESSION (r√©sultat de 'bw unlock --raw') :
          (tu peux copier-coller la valeur affich√©e par 'echo $BW_SESSION')
      register: bw_prompt
      when: bw_session == ""
      no_log: true

    - name: D√©finir BW_SESSION depuis la saisie utilisateur si n√©cessaire
      ansible.builtin.set_fact:
        bw_session: "{{ bw_prompt.user_input }}"
      when: bw_session == "" and bw_prompt.user_input is defined
    - name: V√©rifier la pr√©sence du fichier d'artefact Vault
      ansible.builtin.stat:
        path: "{{ artifact_file }}"
      register: vault_artifact

    - name: √âchec si artefact manquant
      ansible.builtin.fail:
        msg: "‚ùå Le fichier {{ artifact_file }} est introuvable. Lance vault_k8s_post_init.yml d‚Äôabord."
      when: not vault_artifact.stat.exists

    - name: Charger le root_token depuis l‚Äôartefact
      ansible.builtin.command: jq -r '.root_token' "{{ artifact_file }}"
      register: vault_token
      changed_when: false

    - name: R√©cup√©rer le nom du pod Vault
      ansible.builtin.command: >
        kubectl get pods -n {{ namespace }}
        -l app.kubernetes.io/name=vault
        -o jsonpath='{.items[0].metadata.name}'
      register: vault_pod
      changed_when: false

    - name: Synchroniser Bitwarden
      ansible.builtin.command: bw sync --session {{ bw_session }}
      changed_when: false
      failed_when: false

    - name: Charger les secrets Bitwarden
      ansible.builtin.set_fact:
        mysql_user_xwiki: "{{ lookup('pipe', 'bw get item mysql_user_xwiki --session ' + bw_session + ' | jq -r .login.username') }}"
        mysql_password_xwiki: "{{ lookup('pipe', 'bw get item mysql_password_xwiki --session ' + bw_session + ' | jq -r .login.password') }}"
        mysql_db_xwiki: "{{ lookup('pipe', 'bw get item mysql_db_xwiki --session ' + bw_session + ' | jq -r .login.password') }}"
        token_cloudflare: "{{ lookup('pipe', 'bw get item token_cloudflare --session ' + bw_session + ' | jq -r .login.password') }}"
      no_log: true

    - name: D√©finir les secrets applicatifs
      ansible.builtin.set_fact:
        app_secrets:
          - path: "secret/xwiki/database"
            data:
              username: "{{ mysql_user_xwiki }}"
              password: "{{ mysql_password_xwiki }}"
              dbname: "{{ mysql_db_xwiki }}"
          - path: "secret/mysql/root"
            data:
              username: "root"
              password: "{{ mysql_password_xwiki }}"
          - path: "secret/cert-manager/cloudflare"
            data:
              api_token: "{{ token_cloudflare }}"

    - name: Activer le moteur de secrets KV v2
      ansible.builtin.command: >
        kubectl exec -n {{ namespace }} {{ vault_pod.stdout }} --
        env VAULT_ADDR={{ vault_addr }} VAULT_TOKEN={{ vault_token.stdout }}
        vault secrets enable -path=secret kv-v2
      register: kv_enable
      failed_when: >
        kv_enable.rc != 0 and ('path is already in use' not in kv_enable.stderr)
      changed_when: "'success' in (kv_enable.stdout | lower | default(''))"

    - name: Injecter les secrets applicatifs dans Vault
      ansible.builtin.shell: |
        echo '{{ item.data | to_json }}' | \
        kubectl exec -i -n {{ namespace }} {{ vault_pod.stdout }} -- \
        env VAULT_ADDR={{ vault_addr }} VAULT_TOKEN={{ vault_token.stdout }} \
        vault kv put {{ item.path }} -
      loop: "{{ app_secrets }}"
      register: vault_put
      changed_when: "'created' in vault_put.stdout or 'updated' in vault_put.stdout"

    - name: V√©rifier la lecture des secrets inject√©s
      ansible.builtin.command: >
        kubectl exec -n {{ namespace }} {{ vault_pod.stdout }} --
        env VAULT_ADDR={{ vault_addr }} VAULT_TOKEN={{ vault_token.stdout }}
        vault kv get -format=json {{ item.path }}
      loop: "{{ app_secrets }}"
      register: vault_get
      changed_when: false
      failed_when: vault_get.rc != 0

    - name: R√©sum√© final
      ansible.builtin.debug:
        msg:
          - "‚úÖ Secrets Bitwarden inject√©s dans Vault avec succ√®s"
          - "{{ vault_get.results | map(attribute='item.path') | list }}"
