---
# playbooks/master/05-sync_kubeconfig.yml
# Synchroniser kubeconfig depuis master1 vers bastion

- name: Récupérer kubeconfig depuis master
  hosts: master
  gather_facts: false
  become: true

  tasks:
    - name: Lire le kubeconfig du master
      ansible.builtin.slurp:
        src: /etc/kubernetes/admin.conf
      register: admin_conf_raw

    - name: Sauvegarder le contenu dans un fichier temporaire local sur bastion
      delegate_to: bastion_host
      run_once: true
      ansible.builtin.copy:
        content: "{{ admin_conf_raw.content | b64decode }}"
        dest: "/tmp/admin.conf.master1"
        mode: "0600"

- name: Déployer kubeconfig sur bastion
  hosts: bastion
  become: true

  vars:
    kubeconfig_path: "/root/.kube/config"

  tasks:
    - name: Créer le dossier ~/.kube
      ansible.builtin.file:
        path: "/root/.kube"
        state: directory
        mode: "0700"

    - name: Copier le kubeconfig depuis /tmp vers ~/.kube/config
      ansible.builtin.copy:
        src: "/tmp/admin.conf.master1"
        dest: "{{ kubeconfig_path }}"
        mode: "0600"

    - name: Supprimer le fichier temporaire
      ansible.builtin.file:
        path: "/tmp/admin.conf.master1"
        state: absent

    - name: Définir KUBECONFIG globalement dans /etc/profile.d
      ansible.builtin.copy:
        dest: /etc/profile.d/kubeconfig.sh
        content: |
          export KUBECONFIG={{ kubeconfig_path }}
        mode: "0644"

    - name: Test de connexion au cluster (si kubectl est dispo)
      ansible.builtin.shell: |
        if command -v kubectl >/dev/null 2>&1; then
          kubectl get nodes
        else
          echo "⚠️  kubectl non installé sur bastion, test ignoré"
        fi
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Afficher le résultat du test
      ansible.builtin.debug:
        msg: "{{ kubectl_check.stdout_lines }}"

    - name: Supprimer le taint control-plane sur master1 (cluster single-master)
      ansible.builtin.command: >
        kubectl taint nodes master1 node-role.kubernetes.io/control-plane:NoSchedule-
      register: untaint_result
      changed_when: "'taint(s) removed' in untaint_result.stdout"
      failed_when: false

    - name: Vérifier les taints restants
      ansible.builtin.shell: |
        kubectl describe node master1 | grep Taints || true
      register: taints_check
      changed_when: false
      failed_when: false

    - name: Afficher l'état final du nœud master1
      ansible.builtin.debug:
        msg: "{{ taints_check.stdout_lines }}"
