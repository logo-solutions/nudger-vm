---
- name: Configurer GitHub App sur la VM
  hosts: master1
  become: true
  vars:
    github_app_name: "nudger-vm"
    app_id: "123456"            # <-- à mettre depuis GitHub
    installation_id: "987654"   # <-- à mettre depuis GitHub
    key_path: "/etc/github-app/nudger-vm.private-key.pem"
    script_path: "/usr/local/bin/github-app-token.sh"

  tasks:
    - name: Créer dossier config GitHub App
      file:
        path: /etc/github-app
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Déployer App ID
      copy:
        dest: "/etc/github-app/APP_ID"
        content: "{{ app_id }}"
        owner: root
        group: root
        mode: "0600"

    - name: Déployer Installation ID
      copy:
        dest: "/etc/github-app/INSTALLATION_ID"
        content: "{{ installation_id }}"
        owner: root
        group: root
        mode: "0600"

    - name: Vérifier que la clé privée existe déjà
      stat:
        path: "{{ key_path }}"
      register: app_key

    - name: Forcer les permissions sur la clé privée (déjà copiée via scp)
      file:
        path: "{{ key_path }}"
        owner: root
        group: root
        mode: "0600"
      when: app_key.stat.exists

    - name: Déployer le script github-app-token.sh
      copy:
        dest: "{{ script_path }}"
        mode: "0755"
        owner: root
        group: root
        content: |
          #!/usr/bin/env ruby
          require "openssl"
          require "jwt"

          app_id = File.read("/etc/github-app/APP_ID").strip
          installation_id = File.read("/etc/github-app/INSTALLATION_ID").strip
          private_pem = File.read("/etc/github-app/nudger-vm.private-key.pem")
          private_key = OpenSSL::PKey::RSA.new(private_pem)

          payload = {
            iat: Time.now.to_i,
            exp: Time.now.to_i + (10 * 60),
            iss: app_id
          }
          jwt = JWT.encode(payload, private_key, "RS256")

          # Récupérer le token d'installation via curl
          token_url = "https://api.github.com/app/installations/#{installation_id}/access_tokens"
          cmd = "curl -s -X POST -H 'Authorization: Bearer #{jwt}' -H 'Accept: application/vnd.github+json' #{token_url}"
          puts `#{cmd}`
