---
- name: Configurer GitHub App pour cloner nudger-vm
  hosts: master1
  become: true
  vars:
    github_app_id: "123456"            # <-- à remplacer par ton App ID
    github_installation_id: "654321"   # <-- à remplacer par ton Installation ID
    github_pem_src: "/root/nudger-vm/infra/k8s_ansible/secrets/nudger-vm.private-key.pem"
    github_pem_dest: "/root/.ssh/github-app.pem"

  tasks:
    - name: Créer dossier .ssh si absent
      file:
        path: "/root/.ssh"
        state: directory
        mode: "0700"
        owner: root
        group: root

    - name: Copier clé privée GitHub App
      copy:
        src: "{{ github_pem_src }}"
        dest: "{{ github_pem_dest }}"
        owner: root
        group: root
        mode: "0600"
        remote_src: true

    - name: Copier App ID
      copy:
        content: "{{ github_app_id }}"
        dest: "/root/.ssh/github-app-id"
        owner: root
        group: root
        mode: "0600"

    - name: Copier Installation ID
      copy:
        content: "{{ github_installation_id }}"
        dest: "/root/.ssh/github-installation-id"
        owner: root
        group: root
        mode: "0600"

    - name: Installer script github-app-token.sh
      copy:
        dest: "/usr/local/bin/github-app-token.sh"
        mode: "0755"
        content: |
          #!/usr/bin/env bash
          set -euo pipefail
          APP_ID=$(cat /root/.ssh/github-app-id)
          INSTALLATION_ID=$(cat /root/.ssh/github-installation-id)
          PEM_FILE="/root/.ssh/github-app.pem"

          JWT=$(ruby -ropenssl -rbase64 -rjson -e "
          t = Time.now.to_i
          payload = { iat: t-60, exp: t+600, iss: APP_ID.to_i }
          key = OpenSSL::PKey::RSA.new(File.read(PEM_FILE))
          require 'jwt'
          puts JWT.encode(payload, key, 'RS256')
          ")

          curl -s -X POST \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens \
            | jq -r .token
