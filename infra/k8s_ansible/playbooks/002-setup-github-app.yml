---
- name: Configurer GitHub App sur master1
  hosts: master1
  become: true
  vars:
    github_app_dir: "/etc/github-app"
    github_app_pem: "{{ github_app_dir }}/nudger-vm.private-key.pem"

  tasks:
    - name: Créer dossier de config GitHub App
      file:
        path: "{{ github_app_dir }}"
        state: directory
        mode: "0700"

    - name: Copier App ID
      copy:
        dest: "{{ github_app_dir }}/APP_ID"
        content: "{{ lookup('env', 'GITHUB_APP_ID') }}"
        mode: "0600"

    - name: Copier Installation ID
      copy:
        dest: "{{ github_app_dir }}/INSTALLATION_ID"
        content: "{{ lookup('env', 'GITHUB_INSTALLATION_ID') }}"
        mode: "0600"

    - name: Copier clé privée GitHub App
      copy:
        src: "/root/nudger-vm/infra/k8s_ansible/secrets/nudger-vm.private-key.pem"
        dest: "/root/nudger-vm/infra/k8s_ansible/secrets/nudger-vm.private-key.pem"
        remote_src: true
        owner: root
        group: root
        mode: "0600"
    - name: Créer dossier config GitHub App
      file:
        path: /etc/github-app
        state: directory
        mode: "0700"

    - name: Copier clé privée GitHub App
      copy:
        src: secrets/nudger-vm.private-key.pem
        dest: /etc/github-app/nudger-vm.private-key.pem
        owner: root
        group: root
        mode: "0600"

    - name: Convertir la clé en PKCS#8 (si besoin)
      command: >
        openssl pkcs8 -topk8 -inform PEM -outform PEM
        -in /etc/github-app/nudger-vm.private-key.pem
        -out /etc/github-app/nudger-vm.private-key.pem
        -nocrypt
      args:
        creates: /etc/github-app/.converted
      register: pkcs8_convert
      changed_when: pkcs8_convert.rc == 0

    - name: Marquer conversion terminée
      file:
        path: /etc/github-app/.converted
        state: touch

    - name: Installer script github-app-token.sh
      copy:
        dest: /usr/local/bin/github-app-token.sh
        mode: "0755"
        content: |
          #!/usr/bin/env ruby
          require "openssl"
          require "jwt"
          require "net/http"
          require "json"

          app_id = File.read("{{ github_app_dir }}/APP_ID").strip
          installation_id = File.read("{{ github_app_dir }}/INSTALLATION_ID").strip
          private_pem = File.read("{{ github_app_pem }}")

          private_key = OpenSSL::PKey::EC.new(private_pem)

          payload = {
            iat: Time.now.to_i,
            exp: Time.now.to_i + (10 * 60),
            iss: app_id
          }

          jwt = JWT.encode(payload, private_key, "ES256")

          url = URI("https://api.github.com/app/installations/#{installation_id}/access_tokens")
          req = Net::HTTP::Post.new(url)
          req["Authorization"] = "Bearer #{jwt}"
          req["Accept"] = "application/vnd.github+json"

          res = Net::HTTP.start(url.hostname, url.port, use_ssl: true) { |http| http.request(req) }
          data = JSON.parse(res.body)

          puts data["token"]
