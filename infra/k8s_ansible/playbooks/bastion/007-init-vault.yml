---
- name: Installer et initialiser Vault
  hosts: bastion
  become: true
  vars_files:
    - "../../group_vars/vault/vault.yml"
  roles:
    - vault

- name: Créer les utilisateurs via Vault
  hosts: bastion
  become: true
  vars_files:
    - "../../group_vars/vault/vault.yml"
  roles:
    - vault-users

- name: Debug des mots de passe utilisateurs
  hosts: bastion
  tasks:
    - debug:
        var: user_passwords

- name: Seed Vault avec les utilisateurs (mots de passe par défaut)
  hosts: bastion
  become: true
  vars:
    vault_init_file: "{{ lookup('env','HOME') }}/.ansible/artifacts/bastion/vault-init.json"
    vault_addr: "http://127.0.0.1:8200"

  tasks:
    - name: Charger vault-init.json et extraire root_token
      set_fact:
        vault_init_data: "{{ lookup('file', vault_init_file) | from_json }}"
        vault_root_token: "{{ (lookup('file', vault_init_file) | from_json).root_token }}"

    - name: Debug - afficher le root_token tronqué
      debug:
        msg: "Root token récupéré: {{ vault_root_token | regex_replace('(.{6}).*', '\\1...') }}"

    - name: Exporter variables d’env pour Vault (dans facts Ansible)
      set_fact:
        vault_env:
          VAULT_ADDR: "{{ vault_addr }}"
          VAULT_TOKEN: "{{ vault_root_token }}"

    - name: Créer les secrets utilisateurs dans Vault
      command: >
        vault kv put secret/users/{{ item.name }} password={{ item.password | default('changeme123') }}
      environment: "{{ vault_env }}"
      loop: "{{ users_k8s }}"
      register: vault_seed
      changed_when: "'created' in vault_seed.stdout or 'success' in vault_seed.stdout"

    - name: Debug - résumés des créations
      debug:
        var: vault_seed.results | map(attribute='stdout') | list
