---
- name: Installer et initialiser Vault
  hosts: bastion
  become: true
  vars_files:
    - "../../group_vars/vault/vault.yml"
  roles:
    - vault

- name: Créer les utilisateurs via Vault
  hosts: bastion
  become: true
  vars_files:
    - "../../group_vars/vault/vault.yml"
  roles:
    - vault-users

- name: Debug des mots de passe utilisateurs
  hosts: bastion
  tasks:
    - debug:
        var: user_passwords
- name: Seed Vault avec les utilisateurs (mots de passe par défaut)
  hosts: bastion
  become: true
  vars:
    vault_init_file: "/root/.ansible/artifacts/bastion/vault-init.json"
    vault_addr: "http://127.0.0.1:8200"

  tasks:
    - name: Lire le root_token depuis vault-init.json
      command: "jq -r .root_token {{ vault_init_file }}"
      register: vault_token
      changed_when: false

    - name: Debug - afficher le root_token tronqué
      debug:
        msg: "Root token récupéré: {{ vault_token.stdout | regex_replace('(.{6}).*', '\\1...') }}"

    - name: Exporter variables d’env pour Vault (dans facts Ansible)
      set_fact:
        vault_env:
          VAULT_ADDR: "{{ vault_addr }}"
          VAULT_TOKEN: "{{ vault_token.stdout }}"

    - name: Créer les secrets utilisateurs dans Vault
      command: >
        vault kv put secret/users/{{ item.name }} password={{ item.password | default('changeme123') }}
      environment: "{{ vault_env }}"
      loop: "{{ users_k8s }}"
      register: vault_seed
      changed_when: "'created' in vault_seed.stdout or 'success' in vault_seed.stdout"

    - name: Debug - résumés des créations
      debug:
        var: vault_seed.results | map(attribute='stdout') | list
