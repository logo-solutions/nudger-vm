---
# roles/vault-users/tasks/main.yml

- name: Lire les mots de passe depuis Vault
  ansible.builtin.set_fact:
    user_passwords: "{{ user_passwords | default({}) | combine({
      item.name: lookup(
        'community.hashi_vault.hashi_vault',
        'secret=secret/data/users/' ~ item.name,
        token=vault_root_token,
        url=vault_addr,
        field='password',         # ğŸ”‘ On force Ã  rÃ©cupÃ©rer uniquement le champ password
        default='changeme123'     # fallback si le secret nâ€™existe pas
      )
    }) }}"
  loop: "{{ users_k8s }}"

- name: Debug - VÃ©rifier le contenu des mots de passe rÃ©cupÃ©rÃ©s
  debug:
    var: user_passwords
  when: user_passwords is defined

- name: Ensure users exist
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ (item.groups | default([])) | join(',') }}"
    shell: /bin/bash
    create_home: true
    password: "{{ user_passwords[item.name] | password_hash('sha512') }}"
  loop: "{{ users_k8s }}"
