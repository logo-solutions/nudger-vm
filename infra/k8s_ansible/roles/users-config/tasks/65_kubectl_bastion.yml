---
# 65 | install kubectl on bastion host (Ubuntu/Debian compatible)

- name: Check if kubectl is already installed
  ansible.builtin.command: command -v kubectl
  register: kubectl_check
  changed_when: false
  failed_when: false

- name: Install kubectl (pkgs.k8s.io stable v1.31)
  become: true
  when: kubectl_check.rc != 0
  block:
    - name: Ensure APT prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gpg
        state: present
        update_cache: true

    - name: Add Kubernetes repository key
      ansible.builtin.get_url:
        url: https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key
        dest: /etc/apt/keyrings/kubernetes-archive-keyring.asc
        mode: "0644"

    - name: Convert key to GPG
      ansible.builtin.command:
        cmd: "gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg /etc/apt/keyrings/kubernetes-archive-keyring.asc"
      args:
        creates: /etc/apt/keyrings/kubernetes-archive-keyring.gpg

    - name: Add Kubernetes APT source list
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        mode: "0644"
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /

    - name: Install kubectl package
      ansible.builtin.apt:
        name: kubectl
        state: present
        update_cache: true

- name: Verify kubectl version
  ansible.builtin.command: kubectl version --client=true --output=yaml
  register: kubectl_version
  changed_when: false

- name: Show installed kubectl version
  ansible.builtin.debug:
    msg: "{{ kubectl_version.stdout }}"
