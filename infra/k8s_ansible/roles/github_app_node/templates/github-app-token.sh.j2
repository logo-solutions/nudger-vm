#!/usr/bin/env bash
set -euo pipefail

APP_ID_FILE="/etc/github-app/APP_ID"
INSTALLATION_ID_FILE="/etc/github-app/INSTALLATION_ID"
KEY_FILE="/etc/github-app/nudger-vm.private-key.pem"

if [[ ! -f "$APP_ID_FILE" || ! -f "$INSTALLATION_ID_FILE" || ! -f "$KEY_FILE" ]]; then
  echo "❌ Manque un fichier : APP_ID, INSTALLATION_ID ou clé privée."
  exit 1
fi

APP_ID=$(cat "$APP_ID_FILE" | tr -d '[:space:]')
INSTALLATION_ID=$(cat "$INSTALLATION_ID_FILE" | tr -d '[:space:]')

iat=$(date +%s)
exp=$((iat + 540)) # 9 min
header='{"alg":"RS256","typ":"JWT"}'
payload="{\"iat\":$iat,\"exp\":$exp,\"iss\":$APP_ID}"

b64enc() { openssl base64 -e -A | tr '+/' '-_' | tr -d '='; }

jwt_header=$(echo -n "$header" | b64enc)
jwt_payload=$(echo -n "$payload" | b64enc)
unsigned_token="$jwt_header.$jwt_payload"
signature=$(echo -n "$unsigned_token" | openssl dgst -sha256 -sign "$KEY_FILE" | b64enc)
jwt="$unsigned_token.$signature"

token_json=$(curl -s -X POST \
  -H "Authorization: Bearer $jwt" \
  -H "Accept: application/vnd.github+json" \
  https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens)

echo "$token_json" | jq -r '.token'
