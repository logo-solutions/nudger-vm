---
# === Vérification du control-plane avant installation CNI ===
- name: Wait for kube-apiserver to be ready (/readyz)
  ansible.builtin.shell: |
    set -euo pipefail
    for i in $(seq 1 60); do
      if curl -sf --cacert /etc/kubernetes/pki/ca.crt \
         --cert   /etc/kubernetes/pki/apiserver-kubelet-client.crt \
         --key    /etc/kubernetes/pki/apiserver-kubelet-client.key \
         https://{{ ansible_default_ipv4.address }}:6443/readyz >/dev/null 2>&1; then
        exit 0
      fi
      sleep 2
    done
    exit 1
  args: { executable: /bin/bash }
  become: true
  tags: [flannel, check]

# === Namespace Flannel (idempotent) ===
- name: Ensure kube-flannel namespace exists
  ansible.builtin.command:
    argv: ["kubectl", "create", "ns", "kube-flannel", "--dry-run=client", "-o", "yaml"]
  environment: { KUBECONFIG: "/etc/kubernetes/admin.conf" }
  register: ns_yaml
  changed_when: false
  become: true

- name: Apply kube-flannel namespace
  ansible.builtin.command:
    argv: ["kubectl", "apply", "-f", "-"]
  args:
    stdin: "{{ ns_yaml.stdout }}"
  environment: { KUBECONFIG: "/etc/kubernetes/admin.conf" }
  become: true
  tags: [flannel]

# === Installation de Flannel ===
- name: Apply Flannel CNI (robust with retries)
  ansible.builtin.shell: |
    set -euo pipefail
    for i in $(seq 1 10); do
      if kubectl --kubeconfig /etc/kubernetes/admin.conf \
          apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml; then
        exit 0
      fi
      sleep 5
    done
    exit 1
  args: { executable: /bin/bash }
  register: flannel_apply
  changed_when: "'created' in flannel_apply.stdout or 'configured' in flannel_apply.stdout"
  become: true
  tags: [flannel, apply]

# === Attente que Flannel soit prêt ===
- name: Wait for Flannel DaemonSet to be ready
  ansible.builtin.command: >
    kubectl -n kube-flannel rollout status ds/kube-flannel-ds --timeout=5m
  environment:
    KUBECONFIG: "/etc/kubernetes/admin.conf"
  register: flannel_rollout
  retries: 5
  delay: 10
  until: flannel_rollout.rc == 0
  changed_when: false
  become: true
  tags: [flannel, wait]

# === Patch IP masquerade si manquant ===
- name: Ensure flannel has --ip-masq=true
  ansible.builtin.shell: |
    set -euo pipefail
    if ! kubectl -n kube-flannel get ds kube-flannel-ds -o json \
      | jq -e '.spec.template.spec.containers[0].args[]? | select(. == "--ip-masq=true")' >/dev/null; then
      kubectl -n kube-flannel patch ds kube-flannel-ds --type='json' -p='[
        {"op":"add","path":"/spec/template/spec/containers/0/args/-","value":"--ip-masq=true"}
      ]'
    fi
  args: { executable: /bin/bash }
  register: flannel_ipmasq_patch
  changed_when: flannel_ipmasq_patch.rc == 0
  become: true
  tags: [flannel, patch]

- name: Rollout kube-flannel after ip-masq change
  ansible.builtin.command: kubectl -n kube-flannel rollout status ds/kube-flannel-ds --timeout=5m
  when: flannel_ipmasq_patch is changed
  environment:
    KUBECONFIG: "/etc/kubernetes/admin.conf"
  become: true
  tags: [flannel, patch]
