---
# Containerd install + config
- name: Remove legacy containerd config if present
  ansible.builtin.file:
    path: /etc/containerd/config.toml
    state: absent
  become: true
  tags: [containerd]
- name: Install containerd
  ansible.builtin.apt:
    name: containerd
    state: present
    update_cache: true
  become: true
  tags: [containerd]
- name: Ensure /etc/containerd dir exists
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: "0755"
  become: true
  tags: [containerd]
- name: Write crictl.yaml pointing to containerd
  ansible.builtin.copy:
    dest: /etc/crictl.yaml
    mode: "0644"
    content: |
      runtime-endpoint: unix:///var/run/containerd/containerd.sock
      image-endpoint: unix:///var/run/containerd/containerd.sock
      timeout: 10
      debug: false
  become: true
  tags: [containerd]
- name: Deploy containerd config
  ansible.builtin.copy:
    dest: /etc/containerd/config.toml
    mode: "0644"
    content: "{{ containerd_config }}"
  notify: Restart containerd
  become: true
  tags: [containerd]
- name: Ensure containerd is running and enabled
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: true
  become: true
  tags: [containerd]
- name: Wait for containerd to be running
  ansible.builtin.shell: |
    for i in $(seq 1 60); do
      if systemctl is-active --quiet containerd; then
        exit 0
      fi
      sleep 2
    done
    echo "containerd not running"; exit 1
  become: true
- name: Wait for etcd to be running
  ansible.builtin.shell: |
    for i in $(seq 1 60); do
      if crictl ps --name etcd | grep -q Running; then
        exit 0
      fi
      sleep 2
    done
    echo "etcd not running"; exit 1
  become: true

