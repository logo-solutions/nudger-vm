---
# ----------------------------
# Kubernetes repo & packages (FORCE v1.31)
# ----------------------------

- name: Ensure deps for HTTPS APT
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gpg
    state: present
    update_cache: true
  become: true

- name: Ensure /etc/apt/keyrings exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true

- name: Fetch Kubernetes Release.key (minor {{ k8s_version.split('.')[0:2] | join('.') }})
  ansible.builtin.get_url:
    url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_version.split('.')[0:2] | join('.') }}/deb/Release.key"
    dest: /etc/apt/keyrings/kubernetes-Release.key
    mode: "0644"
  become: true

- name: Dearmor -> kubernetes-archive-keyring.gpg
  ansible.builtin.command:
    cmd: "gpg --dearmor -o /etc/apt/keyrings/kubernetes-archive-keyring.gpg /etc/apt/keyrings/kubernetes-Release.key"
  args:
    creates: /etc/apt/keyrings/kubernetes-archive-keyring.gpg
  become: true

- name: Write kubernetes.list
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    mode: "0644"
    content: |
      deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s_version.split('.')[0:2] | join('.') }}/deb/ /
  become: true

- name: Refresh apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 0
  become: true

# ----------------------------
# Paquets Kubernetes
# ----------------------------

- name: Unhold kube packages
  ansible.builtin.shell: |
    for p in kubeadm kubelet kubectl; do
      apt-mark unhold "$p" || true
    done
  args: { executable: /bin/bash }
  become: true
- name: Check held packages
  ansible.builtin.command: apt-mark showhold
  register: held_pkgs
  changed_when: false
  become: true

- debug:
    var: held_pkgs.stdout_lines

- name: Install Kubernetes tools (force upgrade, bypass hold)
  ansible.builtin.command: >
    apt-get install -y --allow-change-held-packages
    kubeadm={{ k8s_version }}
    kubelet={{ k8s_version }}
    kubectl={{ k8s_version }}
  become: true

- name: Hold kube packages again
  ansible.builtin.command: apt-mark hold kubeadm kubelet kubectl
  become: true

- name: Hold kube packages again
  ansible.builtin.shell: |
    apt-mark hold kubeadm kubelet kubectl
  args: { executable: /bin/bash }
  become: true

- name: Enable & restart kubelet
  ansible.builtin.systemd:
    name: kubelet
    enabled: true
    state: restarted
  become: true

- name: Wait for kubelet service active
  ansible.builtin.shell: |
    for i in $(seq 1 30); do
      systemctl is-active --quiet kubelet && exit 0
      sleep 2
    done
    exit 1
  args: { executable: /bin/bash }
  register: kubelet_up
  changed_when: false
  failed_when: kubelet_up.rc != 0
