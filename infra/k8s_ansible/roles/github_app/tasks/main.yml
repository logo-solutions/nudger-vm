---
- name: Déployer le script github-app-token.sh
  template:
    src: github-app-token.sh.j2
    dest: /usr/local/bin/github-app-token.sh
    owner: root
    group: root
    mode: '0755'

- name: Setup GitHub App
  block:

    - name: S'assurer que /etc/github-app existe
      file:
        path: "{{ github_app_secrets_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Déployer APP_ID
      copy:
        dest: "{{ github_app_secrets_dir }}/APP_ID"
        content: "{{ github_app_id }}"
        owner: root
        group: root
        mode: '0600'

    - name: Déployer INSTALLATION_ID
      copy:
        dest: "{{ github_app_secrets_dir }}/INSTALLATION_ID"
        content: "{{ github_app_installation_id }}"
        owner: root
        group: root
        mode: '0600'

    - name: Vérifier que la clé privée existe
      stat:
        path: "{{ github_app_private_key_file }}"
      register: key_stat

    - name: Forcer les permissions (600) si la clé existe
      file:
        path: "{{ github_app_private_key_file }}"
        owner: root
        group: root
        mode: '0600'
      when: key_stat.stat.exists

    - name: Vérifier les 3 premières lignes pour contrôle visuel
      command: head -3 "{{ github_app_private_key_file }}"
      register: head_key
      changed_when: false
      when: key_stat.stat.exists

    - name: Afficher les 3 premières lignes de la clé
      debug:
        msg: "Clé GitHub App (head -3): {{ head_key.stdout_lines }}"
      when: key_stat.stat.exists

    # ---------------------------
    # Génération du JWT (via OpenSSL CLI)
    # ---------------------------

    - name: Créer l’entête JWT (base64url)
      set_fact:
        jwt_header: "{{ {'alg': 'RS256', 'typ': 'JWT'} | to_json | b64encode | regex_replace('=+$','') | regex_replace('\\+', '-') | regex_replace('/', '_') }}"

    - name: Créer le payload JWT (base64url)
      set_fact:
        jwt_payload: >-
          {{ {'iat': (ansible_date_time.epoch | int) - 60,
              'exp': (ansible_date_time.epoch | int) + 600,
              'iss': github_app_id }
              | to_json
              | b64encode
              | regex_replace('=+$','')
              | regex_replace('\\+', '-')
              | regex_replace('/', '_') }}

    - name: Construire le message JWT (header.payload)
      set_fact:
        jwt_message: "{{ jwt_header }}.{{ jwt_payload }}"

    - name: Écrire le message JWT temporaire
      copy:
        dest: /tmp/jwt.msg
        content: "{{ jwt_message }}"
        mode: '0600'

    - name: Signer le message avec OpenSSL
      command: >
        openssl dgst -sha256 -sign {{ github_app_private_key_file }} -out /tmp/jwt.sig /tmp/jwt.msg

    - name: Lire la signature
      slurp:
        src: /tmp/jwt.sig
      register: sig_bin

    - name: Encoder signature en base64url
      set_fact:
        jwt_signature: "{{ sig_bin.content | b64decode | b64encode | regex_replace('=+$','') | regex_replace('\\+', '-') | regex_replace('/', '_') }}"

    - name: Construire le JWT final
      set_fact:
        github_jwt: "{{ jwt_message }}.{{ jwt_signature }}"

    - name: Debug - JWT généré (tronqué)
      debug:
        msg: "JWT généré: {{ github_jwt[0:40] }}..."

    # ---------------------------
    # Utilisation du JWT pour obtenir un token d’installation
    # ---------------------------

    - name: Créer un token d’installation GitHub App
      uri:
        url: "https://api.github.com/app/installations/{{ github_app_installation_id }}/access_tokens"
        method: POST
        headers:
          Authorization: "Bearer {{ github_jwt }}"
          Accept: "application/vnd.github+json"
        return_content: true
      register: github_installation_token
      failed_when: github_installation_token.status not in [200, 201]

    - name: Sauvegarder le token GitHub App dans un fichier
      copy:
        dest: "{{ github_app_secrets_dir }}/GITHUB_TOKEN"
        content: "{{ (github_installation_token.json.token | default('')) ~ '\n' }}"
        owner: root
        group: root
        mode: '0600'

    - name: Debug - Afficher expiration du token
      debug:
        msg: "Token généré, valable jusqu’à {{ github_installation_token.json.expires_at | default('inconnu') }}"
