---
- name: Setup GitHub App secrets
  hosts: k8s_masters
  become: true

  vars:
    github_app_id: "2024451"            # <-- remplace avec ton vrai APP_ID
    github_installation_id: "87738262"  # <-- remplace avec ton vrai INSTALLATION_ID
    github_private_key_src: "secrets/nudger-vm.private-key.pem"  # chemin relatif à ton repo
    github_private_key_dest: "/etc/github-app/nudger-vm.private-key.pem"

  tasks:
    - name: S'assurer que /etc/github-app existe
      file:
        path: /etc/github-app
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Déployer l'App ID
      copy:
        content: "{{ github_app_id }}"
        dest: /etc/github-app/APP_ID
        owner: root
        group: root
        mode: '0600'

    - name: Déployer l'Installation ID
      copy:
        content: "{{ github_installation_id }}"
        dest: /etc/github-app/INSTALLATION_ID
        owner: root
        group: root
        mode: '0600'

    - name: Déployer la clé privée GitHub App
      copy:
        src: "{{ github_private_key_src }}"
        dest: "{{ github_private_key_dest }}"
        owner: root
        group: root
        mode: '0600'

    - name: Vérifier les 3 premières lignes de la clé
      command: head -3 {{ github_private_key_dest }}
      register: head_key
      changed_when: false

    - name: Afficher les 3 premières lignes (debug visuel)
      debug:
        msg: "Clé GitHub App: {{ head_key.stdout_lines }}"
