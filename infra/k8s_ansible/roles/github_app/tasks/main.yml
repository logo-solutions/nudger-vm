---
- name: Setup GitHub App
  block:
    - name: S'assurer que /etc/github-app existe
      file:
        path: "{{ github_app_secrets_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0700'

    - name: Vérifier que la clé privée existe
      stat:
        path: "{{ github_app_private_key_file }}"
      register: key_stat

    - name: Forcer les permissions (600) si la clé existe
      file:
        path: "{{ github_app_private_key_file }}"
        owner: root
        group: root
        mode: '0600'
      when: key_stat.stat.exists
  - name: Déployer APP_ID
    copy:
      dest: "{{ github_app_secrets_dir }}/APP_ID"
      content: "{{ github_app_id }}"
      owner: root
      group: root
      mode: '0600'

    - name: Déployer INSTALLATION_ID
      copy:
        dest: "{{ github_app_secrets_dir }}/INSTALLATION_ID"
        content: "{{ github_app_installation_id }}"
        owner: root
        group: root
        mode: '0600'

      - name: Générer un JWT avec Ruby (fallback pour Ansible 2.10)
        command: |
          ruby -ropenssl -rjson -rtime -rjwt -e '
            app_id = File.read("{{ github_app_app_id_file }}").strip
            pem    = File.read("{{ github_app_private_key_file }}")
            key    = OpenSSL::PKey::RSA.new(pem)
            payload = {
              iat: Time.now.to_i - 60,
              exp: Time.now.to_i + 600,
              iss: app_id
            }
            jwt = JWT.encode(payload, key, "RS256")
            puts jwt
          '
        register: github_jwt
        changed_when: false

    - name: Créer un token d’installation GitHub App
      uri:
        url: "https://api.github.com/app/installations/{{ github_app_installation_id }}/access_tokens"
        method: POST
        headers:
          Authorization: "Bearer {{ github_jwt.stdout }}"
          Accept: "application/vnd.github+json"
        return_content: true
      register: github_installation_token
      failed_when: github_installation_token.status not in [200, 201]

    - name: Sauvegarder le token GitHub App dans un fichier
      copy:
        dest: "{{ github_app_secrets_dir }}/GITHUB_TOKEN"
        content: "{{ (github_installation_token.json.token | default('')) ~ '\n' }}"
        owner: root
        group: root
        mode: '0600'

    - name: Debug - Afficher expiration du token
      debug:
        msg: "Token généré, valable jusqu’à {{ github_installation_token.json.expires_at | default('inconnu') }}"
