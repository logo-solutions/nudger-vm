---
- name: S'assurer que /etc/github-app existe
  file:
    path: /etc/github-app
    state: directory
    owner: root
    group: root
    mode: '0700'

- name: Déployer l'App ID
  copy:
    dest: /etc/github-app/APP_ID
    content: "{{ github_app_id }}"
    owner: root
    group: root
    mode: '0600'

- name: Déployer l'Installation ID
  copy:
    dest: /etc/github-app/INSTALLATION_ID
    content: "{{ github_app_installation_id }}"
    owner: root
    group: root
    mode: '0600'

- name: Vérifier que la clé privée existe déjà
  stat:
    path: /etc/github-app/nudger-vm.private-key.pem
  register: key_stat

- name: Forcer les permissions (600) si la clé existe
  file:
    path: /etc/github-app/nudger-vm.private-key.pem
    owner: root
    group: root
    mode: '0600'
  when: key_stat.stat.exists

- name: Vérifier les 3 premières lignes pour contrôle visuel
  command: head -3 /etc/github-app/nudger-vm.private-key.pem
  register: head_key
  changed_when: false
  when: key_stat.stat.exists

- name: Afficher les 3 premières lignes de la clé
  debug:
    msg: "Clé GitHub App (head -3): {{ head_key.stdout_lines }}"
  when: key_stat.stat.exists
