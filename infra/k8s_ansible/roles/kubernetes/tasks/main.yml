---
- name: Derive minor (M.m) from k8s_version (no regex)
  ansible.builtin.set_fact:
    k8s_minor_local: "{{ (k8s_version.split('.')[0:2] | join('.')) if (k8s_version is defined and (k8s_version|length)>0) else '1.31' }}"

- debug:
    msg:
      k8s_version: "{{ k8s_version }}"
      k8s_minor_local: "{{ k8s_minor_local }}"

# ================================
# Gestion du swap
# ================================
- name: Check active swap
  ansible.builtin.command: swapon --noheadings --show=NAME
  register: _swapon
  changed_when: false
  failed_when: false
  tags: [swap]

- name: Disable swap at runtime if any is active
  ansible.builtin.command: swapoff -a
  when: _swapon.stdout | trim | length > 0
  changed_when: true
  tags: [swap]

- name: Comment swap entries in /etc/fstab (keep a backup)
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^\s*([^#].*\s+swap\s+.*)$'
    replace: '# \1'
    backup: true
  when: disable_swap_comment_fstab | bool
  tags: [swap, fstab]
- name: Create systemd unit to ensure swap is off at boot
  ansible.builtin.copy:
    dest: "/etc/systemd/system/{{ disable_swap_unit_name }}"
    mode: "0644"
    content: |
      [Unit]
      Description=Disable swap at boot (required by Kubernetes)
      Before=kubelet.service
      DefaultDependencies=no
      After=local-fs.target

      [Service]
      Type=oneshot
      ExecStart=/sbin/swapoff -a
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
  when: disable_swap_create_systemd_unit | bool
  notify: Reload systemd
  tags: [swap, systemd]

- name: Enable + start disable-swap service
  ansible.builtin.systemd:
    name: "{{ disable_swap_unit_name }}"
    enabled: true
    state: started
  when: disable_swap_create_systemd_unit | bool
  tags: [swap, systemd]

- name: Set vm.swappiness sysctl
  ansible.posix.sysctl:
    name: vm.swappiness
    value: "{{ disable_swap_sysctl_value }}"
    state: present
    sysctl_set: true
    reload: true
  when: disable_swap_set_sysctl | bool
  tags: [swap, sysctl]

- name: Show final swap status (for logs)
  ansible.builtin.command: swapon --show
  register: _swap_status
  changed_when: false
  failed_when: false
  tags: [swap]

- name: Debug final swap status
  ansible.builtin.debug:
    msg: >-
      Swap actif ? {{ (_swap_status.stdout | trim) != '' }}
  tags: [swap]

# ================================
# Kubernetes APT repo + packages
# ================================
- name: Derive minor (M.m) from k8s_version (no regex)
  ansible.builtin.set_fact:
    k8s_minor_local: "{{ (k8s_version.split('.')[0:2] | join('.')) if (k8s_version is defined and (k8s_version|length)>0) else '1.31' }}"

- name: Sanity print K8s vars
  ansible.builtin.debug:
    msg:
      k8s_version: "{{ k8s_version | default('UNDEF') }}"
      k8s_minor: "{{ k8s_minor | default('UNDEF') }}"
      key_url: "{{ kubernetes_gpg_key_url | default('UNDEF') }}"
      repo: "{{ kubernetes_repo | default('UNDEF') }}"

- name: Ensure apt keyrings directory exists
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true
  tags: ["k8s", "repo"]

- name: Download Kubernetes Release key (ASCII)
  ansible.builtin.get_url:
    url: "https://pkgs.k8s.io/core:/stable:/v{{ k8s_minor_local }}/deb/Release.key"
    dest: /tmp/kubernetes-release.asc
    mode: "0644"
  become: true
  tags: ["k8s", "repo"]

- name: Add Kubernetes APT repository (pkgs.k8s.io)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s_minor_local }}/deb/ /"
    filename: kubernetes
    state: present
    update_cache: true
  become: true
  tags: ["k8s", "repo"]

- name: Convert Release key to binary keyring
  ansible.builtin.command: >
    gpg --dearmor -o {{ kubernetes_keyring_path }} /tmp/kubernetes-release.asc
  args:
    creates: "{{ kubernetes_keyring_path }}"
  become: true
  tags: ["k8s", "repo"]

- name: Remove temporary ASCII key
  ansible.builtin.file:
    path: /tmp/kubernetes-release.asc
    state: absent
  become: true
  tags: ["k8s", "repo"]

- name: Remove legacy kubernetes.list if present
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/kubernetes.list
    state: absent
  become: true
  tags: ["k8s", "repo"]

- name: Remove legacy Kubernetes apt sources (old prod-cdn/isv format)
  ansible.builtin.shell: |
    set -euo pipefail
    for f in /etc/apt/sources.list.d/*.list /etc/apt/sources.list.d/*.sources; do
      [ -f "$f" ] || continue
      if grep -Eiq '(prod-cdn\.packages\.k8s\.io|isv:/kubernetes:/core:/stable)' "$f"; then
        rm -f "$f"
      fi
    done
  args:
    executable: /bin/bash
  register: _legacy_k8s_sources
  changed_when: _legacy_k8s_sources.rc == 0

- name: Add Kubernetes APT repository (pkgs.k8s.io)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by={{ kubernetes_keyring_path }}] https://pkgs.k8s.io/core:/stable:/v{{ k8s_minor_local }}/deb/ /"
    filename: kubernetes
    state: present
    update_cache: true
  become: true
  tags: ["k8s", "repo"]

- name: Install common APT dependencies
  ansible.builtin.apt:
    name: "{{ common_apt_dependencies }}"
    state: present
    update_cache: true
  become: true
  tags: ["k8s", "packages"]

- name: Check held packages
  ansible.builtin.command: apt-mark showhold
  register: held_pkgs
  changed_when: false
  become: true

- debug:
    var: held_pkgs.stdout_lines

# ================================
# INSTALL forc√©e des binaires K8s
# ================================
- name: Build flat string of Kubernetes packages
  ansible.builtin.set_fact:
    kubernetes_packages_str: "{{ kubernetes_packages | join(' ') }}"

- name: Force install Kubernetes packages (bypass held)
  ansible.builtin.shell: |
    apt-get install -y --allow-change-held-packages {{ kubernetes_packages_str }}
  become: true
  notify: Restart kubelet
  tags: ["k8s", "packages"]

- name: Build package name list (strip =version)
  ansible.builtin.set_fact:
    kubernetes_package_names: "{{ kubernetes_packages | map('split', '=') | map('first') | list }}"

- name: Hold Kubernetes packages at installed version
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: "{{ kubernetes_package_names }}"
  become: true
  tags: ["k8s", "packages"]
- name: Ensure kubelet service is enabled and running
  ansible.builtin.service:
    name: kubelet
    state: started
    enabled: true
  become: true
  tags: ["k8s", "service"]
